#!/bin/sh

# Based on: https://medium.com/dot-debug/running-chrome-in-a-docker-container-a55e7f4da4a8

readonly G_LOG_I='[INFO]'
readonly G_LOG_W='[WARN]'
readonly G_LOG_E='[ERROR]'

main() {
    launch_xvfb
    launch_window_manager
}

launch_xvfb() {
    # Set defaults if the user did not specify envs.
    export DISPLAY=${XVFB_DISPLAY:-:1}
    local screen=${XVFB_SCREEN:-0}
    local resolution=${XVFB_RESOLUTION:-1280x1024x24}
    local timeout=${XVFB_TIMEOUT:-10}

    # Start and wait for either Xvfb to be fully up or we hit the timeout.
    Xvfb ${DISPLAY} -nolisten tcp -nolisten unix -screen ${screen} ${resolution} &
    sleep 5
#     local loopCount=0
#     until xdpyinfo -display ${DISPLAY} > /dev/null 2>&1
#     do
#         loopCount=$((loopCount+1))
#         rm /tmp/.X1-lock
#         sleep 1
#         if [ ${loopCount} -gt ${timeout} ]
#         then
#             echo "${G_LOG_E} xvfb failed to start."
#             exit 1
#         fi
#     done
}

launch_window_manager() {
    local timeout=${XVFB_TIMEOUT:-5}

    # Start and wait for either fluxbox to be fully up or we hit the timeout.
    fluxbox &
    # local loopCount=0
    # until wmctrl -m > /dev/null 2>&1
    # do
    #     loopCount=$((loopCount+1))
    #     sleep 1
    #     if [ ${loopCount} -gt ${timeout} ]
    #     then
    #         echo "${G_LOG_E} fluxbox failed to start."
    #         exit 1
    #     fi
    # done
    sleep 5
}

# main
if [ -z "${AWS_LAMBDA_RUNTIME_API}" ]; then 
  exec /usr/local/bin/aws-lambda-rie /usr/bin/npx aws-lambda-ric $1
else
  exec /usr/bin/npx aws-lambda-ric $1
fi

echo "TEST 2"
